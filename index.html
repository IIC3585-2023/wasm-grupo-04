<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WASM - G4</title>

    <script src="functions/webWorker.js"></script>
    <script src="functions/solver.js"></script>
    <script src="functions/vanillaSolver.js"></script>
    <script src="functions/cSolver.js"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="heatmap.js"></script>
    <link rel="stylesheet" href="index.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />

    <script>
      const heatmap_data = {
        vanillaJS: {
          x_label: "VanillaJS",
          algorithms: ["QuickSort"],
          image_label: "js.png",
        },
        librariesJS: {
          x_label: "JS + libraries",
          algorithms: ["QuickSort"],
          image_label: "js.png",
        },
        cWasm: {
          x_label: "C code",
          algorithms: ["QuickSort"],
          image_label: "wasm_icon.png",
        },
      };

      window.addEventListener("load", function () {
        heatmapInit(heatmap_data);
      });
      function problemGen() {
        let n_jobs = document.getElementById("n_jobs").value;
        let max_time = document.getElementById("max_time").value;
        let jobs = Array.from(
          { length: n_jobs },
          () => Math.floor(Math.random() * max_time) + 1
        );
        document.getElementById("jobs_array").value = jobs;
      }

      function solve() {
        const resultInput = document.getElementById("result");
        let jobs = document.getElementById("jobs_array").value;
        jobs = jobs.split(",").map((x) => parseInt(x));
        let n_clusters = document.getElementById("n_clusters").value;
        startAnimation(
          heatmap_data.vanillaJS.x_label,
          heatmap_data.vanillaJS.algorithms
        );
        startAnimation(
          heatmap_data.librariesJS.x_label,
          heatmap_data.librariesJS.algorithms
        );
        startAnimation(
          heatmap_data.cWasm.x_label,
          heatmap_data.cWasm.algorithms
        );
        let start = performance.now();
        solveWithWorker(js_solver, [jobs, n_clusters], function (result) {
          // Do something with the result
          changeTime(
            "js_time",
            start,
            heatmap_data.librariesJS.x_label,
            heatmap_data.librariesJS.algorithms
          );
          resultInput.value = result;
        });
        solveWithWorker(vanilla_solver, [jobs, n_clusters], function (result) {
          // Do something with the result
          changeTime(
            "vanilla_time",
            start,
            heatmap_data.vanillaJS.x_label,
            heatmap_data.vanillaJS.algorithms
          );
        });
        const worker = new Worker("functions/wasmWorker.js");

        worker.onmessage = (e) => {
          changeTime(
            "wasm_time",
            start,
            heatmap_data.cWasm.x_label,
            heatmap_data.cWasm.algorithms
          );
        };
        worker.postMessage({ jobs: jobs, n_clusters: n_clusters });

        // const res = solveWithWorker(
        //   c_solver,
        //   [pointer, typedArray.length, n_clusters],
        //   function (result) {
        //     // Do something with the result
        //     changeTime("wasm_time", start);
        //   }
        // );
      }

      function changeTime(idDocument, start, heatmap_x_label, heatmap_y_label) {
        let end = performance.now();
        let time = (end - start) / 1000;
        // round to 3 decimals
        time = Math.round(time * 1000) / 1000;
        time = time.toString().padEnd(5, "0");
        stopAnimation(heatmap_x_label, heatmap_y_label, time);
        document.getElementById(idDocument).innerHTML = time + " s";
      }

      function switchButton() {
        const switchButton = document.getElementById("switch");
        const nJobsInput = document.getElementById("n_jobs");
        const maxTimeInput = document.getElementById("max_time");
        const genContainer = document.querySelector(".jobs-generator");
        nJobsInput.disabled = !switchButton.checked;
        maxTimeInput.disabled = !switchButton.checked;
        genContainer.classList.toggle("off");
      }
    </script>
  </head>
  <body>
    <main>
      <h1>WASM - G4</h1>
      <section class="jobs-generator off">
        <h3>Random Jobs Generator</h3>
        <div class="input-group">
          <span>N° jobs</span>
          <input
            type="number"
            id="n_jobs"
            placeholder="Number of jobs"
            value="1000"
            disabled
            onchange="problemGen()"
          />
        </div>
        <div class="input-group">
          <span>Max time</span>
          <input
            type="number"
            id="max_time"
            placeholder="Max time"
            value="100"
            disabled
            onchange="problemGen()"
          />
        </div>
        <label class="switch">
          <input type="checkbox" id="switch" onclick="switchButton()" />
          <span class="slider round"></span>
        </label>
      </section>
      <div class="input-group">
        <span>Jobs</span>
        <input type="text" id="jobs_array" class="jobs" />
      </div>
      <div class="input-group">
        <span>N° Clusters</span>
        <input
          type="number"
          id="n_clusters"
          placeholder="Number of Clusters"
          value="2"
        />
      </div>

      <button onclick="solve()">Solve</button>

      <section class="time-comparison">
        <div class="time-comparison-item">
          <img src="assets/js_icon.svg" class="icon-js icon-size" />
          <h3>Full Vanilla</h3>
          <span id="vanilla_time">0.000 s</span>
        </div>
        <div class="time-comparison-item">
          <img src="assets/js_icon.svg" class="icon-js icon-size" />
          <h3>With Libraries</h3>
          <span id="js_time">0.000 s</span>
        </div>
        <div class="time-comparison-item">
          <img src="assets/wasm_icon.png" class="icon-wasm icon-size" />
          <h3>C Code</h3>
          <span id="wasm_time">0.000 s</span>
        </div>
      </section>
      <div id="heatmap"></div>
      <div class="input-group">
        <span>Result</span>
        <input readonly type="text" id="result" class="jobs" />
      </div>
    </main>
  </body>
  <script>
    problemGen();
  </script>
</html>
